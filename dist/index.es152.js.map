{"version":3,"file":"index.es152.js","sources":["../node_modules/jws/lib/verify-stream.js"],"sourcesContent":["/*global module*/\nvar Buffer = require('safe-buffer').Buffer;\nvar DataStream = require('./data-stream');\nvar jwa = require('jwa');\nvar Stream = require('stream');\nvar toString = require('./tostring');\nvar util = require('util');\nvar JWS_REGEX = /^[a-zA-Z0-9\\-_]+?\\.[a-zA-Z0-9\\-_]+?\\.([a-zA-Z0-9\\-_]+)?$/;\n\nfunction isObject(thing) {\n  return Object.prototype.toString.call(thing) === '[object Object]';\n}\n\nfunction safeJsonParse(thing) {\n  if (isObject(thing))\n    return thing;\n  try { return JSON.parse(thing); }\n  catch (e) { return undefined; }\n}\n\nfunction headerFromJWS(jwsSig) {\n  var encodedHeader = jwsSig.split('.', 1)[0];\n  return safeJsonParse(Buffer.from(encodedHeader, 'base64').toString('binary'));\n}\n\nfunction securedInputFromJWS(jwsSig) {\n  return jwsSig.split('.', 2).join('.');\n}\n\nfunction signatureFromJWS(jwsSig) {\n  return jwsSig.split('.')[2];\n}\n\nfunction payloadFromJWS(jwsSig, encoding) {\n  encoding = encoding || 'utf8';\n  var payload = jwsSig.split('.')[1];\n  return Buffer.from(payload, 'base64').toString(encoding);\n}\n\nfunction isValidJws(string) {\n  return JWS_REGEX.test(string) && !!headerFromJWS(string);\n}\n\nfunction jwsVerify(jwsSig, algorithm, secretOrKey) {\n  if (!algorithm) {\n    var err = new Error(\"Missing algorithm parameter for jws.verify\");\n    err.code = \"MISSING_ALGORITHM\";\n    throw err;\n  }\n  jwsSig = toString(jwsSig);\n  var signature = signatureFromJWS(jwsSig);\n  var securedInput = securedInputFromJWS(jwsSig);\n  var algo = jwa(algorithm);\n  return algo.verify(securedInput, signature, secretOrKey);\n}\n\nfunction jwsDecode(jwsSig, opts) {\n  opts = opts || {};\n  jwsSig = toString(jwsSig);\n\n  if (!isValidJws(jwsSig))\n    return null;\n\n  var header = headerFromJWS(jwsSig);\n\n  if (!header)\n    return null;\n\n  var payload = payloadFromJWS(jwsSig);\n  if (header.typ === 'JWT' || opts.json)\n    payload = JSON.parse(payload, opts.encoding);\n\n  return {\n    header: header,\n    payload: payload,\n    signature: signatureFromJWS(jwsSig)\n  };\n}\n\nfunction VerifyStream(opts) {\n  opts = opts || {};\n  var secretOrKey = opts.secret||opts.publicKey||opts.key;\n  var secretStream = new DataStream(secretOrKey);\n  this.readable = true;\n  this.algorithm = opts.algorithm;\n  this.encoding = opts.encoding;\n  this.secret = this.publicKey = this.key = secretStream;\n  this.signature = new DataStream(opts.signature);\n  this.secret.once('close', function () {\n    if (!this.signature.writable && this.readable)\n      this.verify();\n  }.bind(this));\n\n  this.signature.once('close', function () {\n    if (!this.secret.writable && this.readable)\n      this.verify();\n  }.bind(this));\n}\nutil.inherits(VerifyStream, Stream);\nVerifyStream.prototype.verify = function verify() {\n  try {\n    var valid = jwsVerify(this.signature.buffer, this.algorithm, this.key.buffer);\n    var obj = jwsDecode(this.signature.buffer, this.encoding);\n    this.emit('done', valid, obj);\n    this.emit('data', valid);\n    this.emit('end');\n    this.readable = false;\n    return valid;\n  } catch (e) {\n    this.readable = false;\n    this.emit('error', e);\n    this.emit('close');\n  }\n};\n\nVerifyStream.decode = jwsDecode;\nVerifyStream.isValid = isValidJws;\nVerifyStream.verify = jwsVerify;\n\nmodule.exports = VerifyStream;\n"],"names":["Buffer","require$$0","DataStream","require$$1","jwa","require$$2","Stream","require$$3","toString","require$$4","util","require$$5","JWS_REGEX","isObject","thing","safeJsonParse","headerFromJWS","jwsSig","encodedHeader","securedInputFromJWS","signatureFromJWS","payloadFromJWS","encoding","payload","isValidJws","string","jwsVerify","algorithm","secretOrKey","err","signature","securedInput","algo","jwsDecode","opts","header","VerifyStream","secretStream","valid","obj","e","verifyStream"],"mappings":"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","x_google_ignoreList":[0]}