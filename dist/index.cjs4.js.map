{"version":3,"file":"index.cjs4.js","sources":["../src/contexts/AppContext.tsx"],"sourcesContent":["import { gql, useQuery } from '@apollo/client'\nimport { createContext, useContext, useEffect, useMemo } from 'react'\nimport hasura from '../hasura'\nimport { AppProps, NavProps } from '../types/app'\nimport { useAuth } from './AuthContext'\n\ntype AppContextProps = AppProps & {\n  loading: boolean\n  error?: Error\n  refetch?: () => void\n}\n\nconst defaultAppContextProps: AppContextProps = {\n  id: '',\n  orgId: null,\n  name: '',\n  title: null,\n  description: null,\n  host: '',\n  hosts: [],\n  enabledModules: {},\n  appPlanId: '',\n  navs: [],\n  settings: {},\n  secrets: {},\n  currencyId: 'TWD',\n  currencies: {},\n  loading: true,\n  options: {\n    video_duration: 0,\n    watched_seconds: 0,\n  },\n  endedAt: null,\n}\n\nconst AppContext = createContext<AppContextProps>(defaultAppContextProps)\nexport const useApp = () => useContext(AppContext)\n\nexport const AppProvider: React.FC<React.PropsWithChildren<{ appId: string }>> = ({ appId, children }) => {\n  const { authToken, refreshToken } = useAuth()\n  const { data, loading, error, refetch } = useQuery<hasura.GET_APP, hasura.GET_APPVariables>(\n    gql`\n      query GET_APP($appId: String!) {\n        currency {\n          id\n          name\n          label\n          unit\n          minor_units\n        }\n\n        app_by_pk(id: $appId) {\n          id\n          org_id\n          name\n          title\n          description\n          app_modules {\n            id\n            module_id\n          }\n          app_plan_id\n          app_navs(order_by: { position: asc }, where: { parent_id: { _is_null: true } }) {\n            id\n            block\n            position\n            label\n            icon\n            href\n            external\n            locale\n            tag\n            parent_id\n            sub_app_navs(order_by: { position: asc }) {\n              id\n              block\n              position\n              label\n              icon\n              href\n              external\n              locale\n              tag\n              parent_id\n            }\n          }\n          app_settings {\n            key\n            value\n          }\n          app_secrets {\n            key\n            value\n          }\n          app_hosts(order_by: { priority: asc }) {\n            host\n          }\n          options\n          ended_at\n        }\n      }\n    `,\n    {\n      variables: { appId },\n      context: { important: true },\n    },\n  )\n  const settings = useMemo(\n    () => Object.fromEntries(data?.app_by_pk?.app_settings.map(v => [v.key, v.value]) || []),\n    [data?.app_by_pk?.app_settings],\n  )\n  const secrets = useMemo(\n    () => Object.fromEntries(data?.app_by_pk?.app_secrets.map(v => [v.key, v.value]) || []),\n    [data?.app_by_pk?.app_secrets],\n  )\n  const app: AppContextProps = useMemo(\n    () =>\n      data?.app_by_pk\n        ? {\n            loading,\n            error,\n            refetch,\n            id: data.app_by_pk.id,\n            orgId: data.app_by_pk.org_id || null,\n            name: data.app_by_pk.name || '',\n            title: data.app_by_pk.title || null,\n            description: data.app_by_pk.description || null,\n            host: data.app_by_pk.app_hosts?.[0]?.host ?? (typeof window !== 'undefined' ? window.location.host : ''),\n            hosts: data?.app_by_pk?.app_hosts.map(v => v.host) || [],\n            enabledModules: Object.fromEntries(data.app_by_pk.app_modules.map(v => [v.module_id, true]) || []),\n            appPlanId: data?.app_by_pk.app_plan_id,\n            navs: data.app_by_pk.app_navs.map(appNav => ({\n              id: appNav.id,\n              block: appNav.block as NavProps['block'],\n              position: appNav.position,\n              label: appNav.label,\n              icon: appNav.icon || null,\n              href: appNav.href,\n              external: appNav.external,\n              locale: appNav.locale,\n              tag: appNav.tag || null,\n              parentId: appNav.parent_id || null,\n              subNavs: appNav.sub_app_navs.map(v => ({\n                id: v.id,\n                block: v.block as NavProps['block'],\n                position: v.position,\n                label: v.label,\n                icon: v.icon || null,\n                href: v.href,\n                external: v.external,\n                locale: v.locale,\n                tag: v.tag || null,\n                parentId: v.parent_id || null,\n              })),\n            })),\n            settings,\n            secrets,\n            currencyId: settings['currency_id'] || 'TWD',\n            currencies:\n              data?.currency.reduce(\n                (accumulator, currency) => {\n                  accumulator[currency.id] = {\n                    id: currency.id,\n                    name: currency.id === 'LSC' && settings['coin.name'] ? settings['coin.name'] : currency.name,\n                    label: currency.id === 'LSC' && settings['coin.label'] ? settings['coin.label'] : currency.label,\n                    unit: currency.id === 'LSC' && settings['coin.unit'] ? settings['coin.unit'] : currency.unit,\n                    minorUnits: currency.minor_units ? currency.minor_units : 0,\n                  }\n                  return accumulator\n                },\n                {} as AppProps['currencies'],\n              ) || {},\n            options: data.app_by_pk.options,\n            endedAt: data.app_by_pk.ended_at || null,\n          }\n        : defaultAppContextProps,\n    [data?.app_by_pk, data?.currency, error, loading, refetch, secrets, settings],\n  )\n\n  useEffect(() => {\n    if (!authToken) {\n      refreshToken?.()\n    }\n  }, [appId, authToken, refreshToken])\n\n  return <AppContext.Provider value={app}>{children}</AppContext.Provider>\n}\n"],"names":["defaultAppContextProps","AppContext","createContext","useApp","useContext","AppProvider","appId","children","authToken","refreshToken","useAuth","data","loading","error","refetch","useQuery","gql","settings","useMemo","v","secrets","app","appNav","accumulator","currency","useEffect"],"mappings":"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"}