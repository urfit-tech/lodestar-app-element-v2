{"version":3,"file":"index.cjs140.js","sources":["../node_modules/jws/lib/verify-stream.js"],"sourcesContent":["/*global module*/\nvar Buffer = require('safe-buffer').Buffer;\nvar DataStream = require('./data-stream');\nvar jwa = require('jwa');\nvar Stream = require('stream');\nvar toString = require('./tostring');\nvar util = require('util');\nvar JWS_REGEX = /^[a-zA-Z0-9\\-_]+?\\.[a-zA-Z0-9\\-_]+?\\.([a-zA-Z0-9\\-_]+)?$/;\n\nfunction isObject(thing) {\n  return Object.prototype.toString.call(thing) === '[object Object]';\n}\n\nfunction safeJsonParse(thing) {\n  if (isObject(thing))\n    return thing;\n  try { return JSON.parse(thing); }\n  catch (e) { return undefined; }\n}\n\nfunction headerFromJWS(jwsSig) {\n  var encodedHeader = jwsSig.split('.', 1)[0];\n  return safeJsonParse(Buffer.from(encodedHeader, 'base64').toString('binary'));\n}\n\nfunction securedInputFromJWS(jwsSig) {\n  return jwsSig.split('.', 2).join('.');\n}\n\nfunction signatureFromJWS(jwsSig) {\n  return jwsSig.split('.')[2];\n}\n\nfunction payloadFromJWS(jwsSig, encoding) {\n  encoding = encoding || 'utf8';\n  var payload = jwsSig.split('.')[1];\n  return Buffer.from(payload, 'base64').toString(encoding);\n}\n\nfunction isValidJws(string) {\n  return JWS_REGEX.test(string) && !!headerFromJWS(string);\n}\n\nfunction jwsVerify(jwsSig, algorithm, secretOrKey) {\n  if (!algorithm) {\n    var err = new Error(\"Missing algorithm parameter for jws.verify\");\n    err.code = \"MISSING_ALGORITHM\";\n    throw err;\n  }\n  jwsSig = toString(jwsSig);\n  var signature = signatureFromJWS(jwsSig);\n  var securedInput = securedInputFromJWS(jwsSig);\n  var algo = jwa(algorithm);\n  return algo.verify(securedInput, signature, secretOrKey);\n}\n\nfunction jwsDecode(jwsSig, opts) {\n  opts = opts || {};\n  jwsSig = toString(jwsSig);\n\n  if (!isValidJws(jwsSig))\n    return null;\n\n  var header = headerFromJWS(jwsSig);\n\n  if (!header)\n    return null;\n\n  var payload = payloadFromJWS(jwsSig);\n  if (header.typ === 'JWT' || opts.json)\n    payload = JSON.parse(payload, opts.encoding);\n\n  return {\n    header: header,\n    payload: payload,\n    signature: signatureFromJWS(jwsSig)\n  };\n}\n\nfunction VerifyStream(opts) {\n  opts = opts || {};\n  var secretOrKey = opts.secret||opts.publicKey||opts.key;\n  var secretStream = new DataStream(secretOrKey);\n  this.readable = true;\n  this.algorithm = opts.algorithm;\n  this.encoding = opts.encoding;\n  this.secret = this.publicKey = this.key = secretStream;\n  this.signature = new DataStream(opts.signature);\n  this.secret.once('close', function () {\n    if (!this.signature.writable && this.readable)\n      this.verify();\n  }.bind(this));\n\n  this.signature.once('close', function () {\n    if (!this.secret.writable && this.readable)\n      this.verify();\n  }.bind(this));\n}\nutil.inherits(VerifyStream, Stream);\nVerifyStream.prototype.verify = function verify() {\n  try {\n    var valid = jwsVerify(this.signature.buffer, this.algorithm, this.key.buffer);\n    var obj = jwsDecode(this.signature.buffer, this.encoding);\n    this.emit('done', valid, obj);\n    this.emit('data', valid);\n    this.emit('end');\n    this.readable = false;\n    return valid;\n  } catch (e) {\n    this.readable = false;\n    this.emit('error', e);\n    this.emit('close');\n  }\n};\n\nVerifyStream.decode = jwsDecode;\nVerifyStream.isValid = isValidJws;\nVerifyStream.verify = jwsVerify;\n\nmodule.exports = VerifyStream;\n"],"names":["Buffer","require$$0","DataStream","require$$1","jwa","require$$2","Stream","require$$3","toString","require$$4","util","require$$5","JWS_REGEX","isObject","thing","safeJsonParse","headerFromJWS","jwsSig","encodedHeader","securedInputFromJWS","signatureFromJWS","payloadFromJWS","encoding","payload","isValidJws","string","jwsVerify","algorithm","secretOrKey","err","signature","securedInput","algo","jwsDecode","opts","header","VerifyStream","secretStream","valid","obj","e","verifyStream"],"mappings":"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","x_google_ignoreList":[0]}