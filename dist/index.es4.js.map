{"version":3,"file":"index.es4.js","sources":["../src/contexts/AppContext.tsx"],"sourcesContent":["import { gql, useQuery } from '@apollo/client'\nimport { createContext, useContext, useEffect, useMemo } from 'react'\nimport hasura from '../hasura'\nimport { AppProps, NavProps } from '../types/app'\nimport { useAuth } from './AuthContext'\n\ntype AppContextProps = AppProps & {\n  loading: boolean\n  error?: Error\n  refetch?: () => void\n}\n\nconst defaultAppContextProps: AppContextProps = {\n  id: '',\n  orgId: null,\n  name: '',\n  title: null,\n  description: null,\n  host: '',\n  hosts: [],\n  enabledModules: {},\n  appPlanId: '',\n  navs: [],\n  settings: {},\n  secrets: {},\n  currencyId: 'TWD',\n  currencies: {},\n  loading: true,\n  options: {\n    video_duration: 0,\n    watched_seconds: 0,\n  },\n  endedAt: null,\n}\n\nconst AppContext = createContext<AppContextProps>(defaultAppContextProps)\nexport const useApp = () => useContext(AppContext)\n\nexport const AppProvider: React.FC<React.PropsWithChildren<{ appId: string }>> = ({ appId, children }) => {\n  const { authToken, refreshToken } = useAuth()\n  const { data, loading, error, refetch } = useQuery<hasura.GET_APP, hasura.GET_APPVariables>(\n    gql`\n      query GET_APP($appId: String!) {\n        currency {\n          id\n          name\n          label\n          unit\n          minor_units\n        }\n\n        app_by_pk(id: $appId) {\n          id\n          org_id\n          name\n          title\n          description\n          app_modules {\n            id\n            module_id\n          }\n          app_plan_id\n          app_navs(order_by: { position: asc }, where: { parent_id: { _is_null: true } }) {\n            id\n            block\n            position\n            label\n            icon\n            href\n            external\n            locale\n            tag\n            parent_id\n            sub_app_navs(order_by: { position: asc }) {\n              id\n              block\n              position\n              label\n              icon\n              href\n              external\n              locale\n              tag\n              parent_id\n            }\n          }\n          app_settings {\n            key\n            value\n          }\n          app_secrets {\n            key\n            value\n          }\n          app_hosts(order_by: { priority: asc }) {\n            host\n          }\n          options\n          ended_at\n        }\n      }\n    `,\n    {\n      variables: { appId },\n      context: { important: true },\n    },\n  )\n  const settings = useMemo(\n    () => Object.fromEntries(data?.app_by_pk?.app_settings.map(v => [v.key, v.value]) || []),\n    [data?.app_by_pk?.app_settings],\n  )\n  const secrets = useMemo(\n    () => Object.fromEntries(data?.app_by_pk?.app_secrets.map(v => [v.key, v.value]) || []),\n    [data?.app_by_pk?.app_secrets],\n  )\n  const app: AppContextProps = useMemo(\n    () =>\n      data?.app_by_pk\n        ? {\n            loading,\n            error,\n            refetch,\n            id: data.app_by_pk.id,\n            orgId: data.app_by_pk.org_id || null,\n            name: data.app_by_pk.name || '',\n            title: data.app_by_pk.title || null,\n            description: data.app_by_pk.description || null,\n            host: data.app_by_pk.app_hosts?.[0]?.host ?? (typeof window !== 'undefined' ? window.location.host : ''),\n            hosts: data?.app_by_pk?.app_hosts.map(v => v.host) || [],\n            enabledModules: Object.fromEntries(data.app_by_pk.app_modules.map(v => [v.module_id, true]) || []),\n            appPlanId: data?.app_by_pk.app_plan_id,\n            navs: data.app_by_pk.app_navs.map(appNav => ({\n              id: appNav.id,\n              block: appNav.block as NavProps['block'],\n              position: appNav.position,\n              label: appNav.label,\n              icon: appNav.icon || null,\n              href: appNav.href,\n              external: appNav.external,\n              locale: appNav.locale,\n              tag: appNav.tag || null,\n              parentId: appNav.parent_id || null,\n              subNavs: appNav.sub_app_navs.map(v => ({\n                id: v.id,\n                block: v.block as NavProps['block'],\n                position: v.position,\n                label: v.label,\n                icon: v.icon || null,\n                href: v.href,\n                external: v.external,\n                locale: v.locale,\n                tag: v.tag || null,\n                parentId: v.parent_id || null,\n              })),\n            })),\n            settings,\n            secrets,\n            currencyId: settings['currency_id'] || 'TWD',\n            currencies:\n              data?.currency.reduce(\n                (accumulator, currency) => {\n                  accumulator[currency.id] = {\n                    id: currency.id,\n                    name: currency.id === 'LSC' && settings['coin.name'] ? settings['coin.name'] : currency.name,\n                    label: currency.id === 'LSC' && settings['coin.label'] ? settings['coin.label'] : currency.label,\n                    unit: currency.id === 'LSC' && settings['coin.unit'] ? settings['coin.unit'] : currency.unit,\n                    minorUnits: currency.minor_units ? currency.minor_units : 0,\n                  }\n                  return accumulator\n                },\n                {} as AppProps['currencies'],\n              ) || {},\n            options: data.app_by_pk.options,\n            endedAt: data.app_by_pk.ended_at || null,\n          }\n        : defaultAppContextProps,\n    [data?.app_by_pk, data?.currency, error, loading, refetch, secrets, settings],\n  )\n\n  useEffect(() => {\n    if (!authToken) {\n      refreshToken?.()\n    }\n  }, [appId, authToken, refreshToken])\n\n  return <AppContext.Provider value={app}>{children}</AppContext.Provider>\n}\n"],"names":["defaultAppContextProps","AppContext","createContext","useApp","useContext","AppProvider","appId","children","authToken","refreshToken","useAuth","data","loading","error","refetch","useQuery","gql","settings","useMemo","v","secrets","app","appNav","accumulator","currency","useEffect"],"mappings":"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"}