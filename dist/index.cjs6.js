"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const y=require("./index.cjs15.js");require("./index.cjs18.js");const A=require("./index.cjs19.js"),N=require("libphonenumber-js"),h=require("react"),B=require("./index.cjs20.js"),E=require("./index.cjs11.js"),p=require("./index.cjs14.js"),a=require("./index.cjs21.js"),S={isAuthenticating:!window.AUTH_TOKEN,isAuthenticated:!1,currentUserRole:"anonymous",currentMemberId:null,authToken:null,currentMember:null,permissions:{},isFinishedSignUpProperty:!0},O=()=>{typeof window<"u"&&(window.lodestar=window.lodestar||{})},T=h.createContext(S),$=()=>h.useContext(T),v=({appId:d,children:P})=>{const[g,C]=h.useState(S.isAuthenticating),[m,i]=h.useState(window.AUTH_TOKEN||null),n=h.useMemo(()=>m?p.parsePayload(m):null,[m]);h.useEffect(()=>{if(n)try{const e=n?.phoneNumber?N(n.phoneNumber,"TW"):null,t=window;t.insider_object={user:{gdpr_optin:!0,sms_optin:!0,email:n.email,phone_number:e?.isValid()?e.number:n.phoneNumber,email_optin:!0}},B.default.set({userId:n.sub})}catch(e){process.env.NODE_ENV==="development"&&console.error(e)}},[n,window]);const I=h.useCallback(async()=>{const e=await p.getFingerPrintId(),{ip:t,country:s,countryCode:r}=await p.fetchCurrentGeolocation(),{data:{code:o,result:c}}=await a.default.post(`${process.env.NEXT_PUBLIC_API_BASE_ROOT}/auth/refresh-token`,{appId:d,fingerPrintId:e,geoLocation:{ip:t,country:s,countryCode:r}},{method:"POST",withCredentials:!0});o==="SUCCESS"?i(c.authToken):o==="E_NO_DEVICE"?(i(null),alert("您已被登出，目前有其他裝置登入這組帳號")):i(null),C(!1)},[d]),f=n&&{id:n.sub,name:n.name,username:n.username,email:n.email,pictureUrl:n.pictureUrl||null,role:n.role,options:n.options||{}};return O(),typeof window<"u"&&(window.lodestar.getCurrentMember=()=>f,window.lodestar.getDataLayerByEvent=e=>window.dataLayer.find(t=>t.event===e)),y.jsxRuntimeExports.jsx(T.Provider,{value:{isAuthenticating:g,isAuthenticated:!!m,currentUserRole:n?.role||"anonymous",currentMemberId:n?.sub||null,authToken:m,updateAuthToken:e=>i(e),isFinishedSignUpProperty:!!n?.isFinishedSignUpProperty,currentMember:f,permissions:n?.permissions?.reduce((e,t)=>(e[t]=!0,e),{})||{},refreshToken:I,register:async e=>a.default.post(`${process.env.NEXT_PUBLIC_API_BASE_ROOT}/auth/register`,{appId:e.appId||d,username:e.username,email:e.email,password:e.password,isBusiness:e.isBusiness??!1},{withCredentials:!0}).then(({data:{code:t,message:s,result:r}})=>{if(t==="SUCCESS"){e.withoutLogin||i(r.authToken);try{const o=A.default.decode(r.authToken)?.sub,c=sessionStorage.getItem("phone");c&&process.env.NEXT_PUBLIC_GRAPHQL_PH_ENDPOINT&&a.default.post(process.env.NEXT_PUBLIC_GRAPHQL_PH_ENDPOINT,{query:`
                        mutation INSERT_MEMBER_PHONE_ONE($currentMemberId: String!, $phone: String!) {
                          insert_member_phone_one(object: { member_id: $currentMemberId, phone: $phone }) {
                            id
                          }
                        }
                    `,variables:{currentMemberId:o,phone:c}},{headers:{Authorization:`Bearer ${r.authToken}`}});const u=JSON.parse(sessionStorage.getItem("categoryIds")||"[]"),_=JSON.parse(sessionStorage.getItem("memberProperties")||"[]");u.length&&process.env.NEXT_PUBLIC_GRAPHQL_PH_ENDPOINT&&a.default.post(process.env.NEXT_PUBLIC_GRAPHQL_PH_ENDPOINT,{query:`
                        mutation INSERT_MEMBER_CATEGORIES($memberProperties: [member_property_insert_input!]!, $data: [member_category_insert_input!]!) {
                          insert_member_property(objects: $memberProperties) {
                            affected_rows
                          }
                          insert_member_category(objects: $data) {
                            affected_rows
                          }
                        }
                      `,variables:{memberProperties:_.map(l=>({member_id:o,property_id:l.propertyId,value:l.value})),data:u.map((l,b)=>({member_id:o,category_id:l,position:b}))}},{headers:{Authorization:`Bearer ${r.authToken}`}});const w=sessionStorage.getItem("star");return w&&process.env.NEXT_PUBLIC_GRAPHQL_PH_ENDPOINT&&a.default.post(process.env.NEXT_PUBLIC_GRAPHQL_PH_ENDPOINT,{query:`
                        mutation SET_MEMBER_STAR($memberId: String!, $star: numeric!) {
                          update_member(where: {id: {_eq: $memberId}}, _set: {star: $star}) {
                            affected_rows
                          }
                        }                      
                      `,variables:{memberId:o,star:parseInt(w)}},{headers:{Authorization:`Bearer ${r.authToken}`}}),r.authToken}catch{}}else throw i(null),new Error(t)}),login:async({account:e,password:t,accountLinkToken:s})=>{const r=await p.getFingerPrintId(),{ip:o,country:c,countryCode:u}=await p.fetchCurrentGeolocation(),{data:{code:_,message:w,result:l}}=await a.default.post(`${process.env.NEXT_PUBLIC_API_BASE_ROOT}/auth/general-login`,{appId:d,account:e,password:t,fingerPrintId:r,geoLocation:{ip:o,country:c,countryCode:u}},{withCredentials:!0});if(_==="SUCCESS")i(l.authToken),s&&l.authToken&&window.location.assign(`/line-binding?accountLinkToken=${s}`);else if(_==="I_RESET_PASSWORD")window.location.assign(`/check-email?email=${e}&type=reset-password`);else throw i(null),E.getBackendServerError(_,w,l);return{code:_}},socialLogin:async({provider:e,providerToken:t,accountLinkToken:s,isForceLogin:r})=>a.default.post(`${process.env.NEXT_PUBLIC_API_BASE_ROOT}/auth/social-login`,{appId:d,provider:e,providerToken:t,isForceLogin:r},{withCredentials:!0}).then(async({data:{code:o,message:c,result:u}})=>{if(o==="SUCCESS"){if(i(u.authToken),!p.parsePayload(u.authToken))throw new Error("no auth token");s&&u.authToken&&window.location.assign(`/line-binding?accountLinkToken=${s}`)}else throw i(null),E.getBackendServerError(o,c,u)}),switchMember:async({memberId:e})=>a.default.post(`${process.env.NEXT_PUBLIC_API_BASE_ROOT}/auth/switch-member`,{memberId:e},{withCredentials:!0,headers:{Authorization:"Bearer "+m}}).then(({data:{code:t,_:s,result:r}})=>{if(t==="SUCCESS")i(r.authToken);else throw new Error(t)}),logout:async()=>{localStorage.clear(),typeof window<"u"&&window.location.assign(`${process.env.NEXT_PUBLIC_API_BASE_ROOT}/auth/logout?redirect=${window.location.href}`)},sendSmsCode:async({phoneNumber:e})=>a.default.post(`${process.env.NEXT_PUBLIC_API_BASE_ROOT}/sms/send-code`,{appId:d,phoneNumber:e},{withCredentials:!0}).then(({data:{code:t}})=>{if(t!=="SUCCESS")throw new Error(t)}),verifySmsCode:async({phoneNumber:e,code:t})=>a.default.post(`${process.env.NEXT_PUBLIC_API_BASE_ROOT}/sms/verify-code`,{appId:d,phoneNumber:e,code:t},{withCredentials:!0}).then(({data:{code:s,_:r,result:o}})=>{if(s!=="SUCCESS"||!o?.codeValid)throw new Error(s)}),forceLogin:async({account:e,password:t,accountLinkToken:s})=>a.default.post(`${process.env.NEXT_PUBLIC_API_BASE_ROOT}/auth/force-login`,{appId:d,account:e,password:t},{withCredentials:!0}).then(({data:{code:r,result:o}})=>{if(r==="SUCCESS")i(o.authToken),s&&o.authToken&&typeof window<"u"&&window.location.assign(`/line-binding?accountLinkToken=${s}`);else if(r==="I_RESET_PASSWORD"&&typeof window<"u")window.location.assign(`/check-email?email=${e}&type=reset-password`);else throw i(null),new Error(r)}).catch(r=>{throw r})},children:P})};exports.AuthProvider=v;exports.useAuth=$;
//# sourceMappingURL=index.cjs6.js.map
